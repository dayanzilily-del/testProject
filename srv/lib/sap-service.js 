const { getDestination } = require('@sap-cloud-sdk/connectivity');
const { executeHttpRequest } = require('@sap-cloud-sdk/http-client');

/**
 * SAP連携サービス（Destination使用版）
 * @sap-cloud-sdk/connectivity を使用してDestinationから認証情報を取得
 */
class SAPService {
  constructor() {
    this.destinationName = 'SAP_DEST';
    this.destination = null;
  }

  /**
   * Destinationを取得して初期化
   */
  async init() {
    if (!this.destination) {
      try {
        this.destination = await getDestination({
          destinationName: this.destinationName
        });
        
        console.log(`✓ SAP Destination "${this.destinationName}" loaded successfully`);
      } catch (error) {
        console.error('SAP Destination取得エラー:', error);
        throw new Error(`Destination "${this.destinationName}" の取得に失敗しました`);
      }
    }
    return this.destination;
  }

  /**
   * 会社マスタを取得
   * @returns {Array} 会社マスタ配列
   */
  async getCompanies() {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: '/CompanyCodeSet',
          params: {
            $select: 'CompanyCode,CompanyCodeName'
          }
        }
      );
      
      const results = response.data?.d?.results || response.data?.value || [];
      
      return results.map(item => ({
        companyCode: item.CompanyCode,
        companyName: item.CompanyCodeName
      }));
    } catch (error) {
      console.error('SAP会社マスタ取得エラー:', error);
      throw new Error(`会社マスタの取得に失敗しました: ${error.message}`);
    }
  }

  /**
   * 会計伝票ヘッダーを取得
   * @param {String} applicationId - 申請ID
   * @returns {Object} 会計伝票ヘッダー
   */
  async getAccountingDocument(applicationId) {
    await this.init();
    
    try {
      // 申請IDから会計伝票番号を取得
      const docNumber = await this.getDocumentNumber(applicationId);
      
      if (!docNumber) {
        return null;
      }
      
      // 会計伝票ヘッダーを取得
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: `/AccountingDocumentHeaderSet(AccountingDocument='${docNumber.documentNumber}',FiscalYear='${docNumber.fiscalYear}',CompanyCode='${docNumber.companyCode}')`,
          params: {
            $expand: 'to_Item'
          }
        }
      );
      
      const header = response.data?.d || response.data;
      
      if (!header) {
        return null;
      }
      
      // 明細を取得
      const items = await this.getAccountingDocumentItems(
        docNumber.documentNumber,
        docNumber.fiscalYear,
        docNumber.companyCode
      );
      
      return {
        documentNumber: header.AccountingDocument,
        fiscalYear: header.FiscalYear,
        companyCode: header.CompanyCode,
        documentType: header.AccountingDocumentType,
        postingDate: header.PostingDate,
        documentDate: header.DocumentDate,
        reference: header.DocumentReferenceID,
        headerText: header.DocumentHeaderText,
        items: items
      };
    } catch (error) {
      console.error('SAP会計伝票取得エラー:', error);
      return null;
    }
  }

  /**
   * 会計伝票明細を取得
   * @param {String} documentNumber - 伝票番号
   * @param {String} fiscalYear - 会計年度
   * @param {String} companyCode - 会社コード
   * @returns {Array} 会計伝票明細配列
   */
  async getAccountingDocumentItems(documentNumber, fiscalYear, companyCode) {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: '/AccountingDocumentItemSet',
          params: {
            $filter: `AccountingDocument eq '${documentNumber}' and FiscalYear eq '${fiscalYear}' and CompanyCode eq '${companyCode}'`,
            $orderby: 'AccountingDocumentItem asc'
          }
        }
      );
      
      const results = response.data?.d?.results || response.data?.value || [];
      
      return results.map(item => ({
        itemNumber: item.AccountingDocumentItem,
        glAccount: item.GLAccount,
        glAccountName: item.GLAccountName,
        amount: item.AmountInCompanyCodeCurrency,
        currency: item.CompanyCodeCurrency,
        debitCredit: item.DebitCreditCode,
        costCenter: item.CostCenter,
        profitCenter: item.ProfitCenter,
        itemText: item.DocumentItemText
      }));
    } catch (error) {
      console.error('SAP会計伝票明細取得エラー:', error);
      return [];
    }
  }

  /**
   * 申請IDから会計伝票番号を取得
   * @param {String} applicationId - 申請ID
   * @returns {Object} 伝票情報
   */
  async getDocumentNumber(applicationId) {
    // 実装は実際のマッピングテーブルまたはロジックに応じて調整
    // ここでは例として固定値を返す
    return {
      documentNumber: '1000000001',
      fiscalYear: '2025',
      companyCode: '1000'
    };
  }

  /**
   * G/L勘定マスタを取得
   * @param {String} companyCode - 会社コード
   * @returns {Array} G/L勘定マスタ配列
   */
  async getGLAccounts(companyCode) {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: '/GLAccountSet',
          params: {
            $filter: `CompanyCode eq '${companyCode}'`,
            $select: 'GLAccount,GLAccountName'
          }
        }
      );
      
      const results = response.data?.d?.results || response.data?.value || [];
      
      return results.map(item => ({
        glAccount: item.GLAccount,
        glAccountName: item.GLAccountName
      }));
    } catch (error) {
      console.error('SAPG/L勘定マスタ取得エラー:', error);
      return [];
    }
  }

  /**
   * コストセンターマスタを取得
   * @param {String} controllingArea - 管理領域
   * @returns {Array} コストセンターマスタ配列
   */
  async getCostCenters(controllingArea) {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: '/CostCenterSet',
          params: {
            $filter: `ControllingArea eq '${controllingArea}'`,
            $select: 'CostCenter,CostCenterName'
          }
        }
      );
      
      const results = response.data?.d?.results || response.data?.value || [];
      
      return results.map(item => ({
        costCenter: item.CostCenter,
        costCenterName: item.CostCenterName
      }));
    } catch (error) {
      console.error('SAPコストセンターマスタ取得エラー:', error);
      return [];
    }
  }

  /**
   * プロフィットセンターマスタを取得
   * @param {String} controllingArea - 管理領域
   * @returns {Array} プロフィットセンターマスタ配列
   */
  async getProfitCenters(controllingArea) {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: '/ProfitCenterSet',
          params: {
            $filter: `ControllingArea eq '${controllingArea}'`,
            $select: 'ProfitCenter,ProfitCenterName'
          }
        }
      );
      
      const results = response.data?.d?.results || response.data?.value || [];
      
      return results.map(item => ({
        profitCenter: item.ProfitCenter,
        profitCenterName: item.ProfitCenterName
      }));
    } catch (error) {
      console.error('SAPプロフィットセンターマスタ取得エラー:', error);
      return [];
    }
  }

  /**
   * 通貨マスタを取得
   * @returns {Array} 通貨マスタ配列
   */
  async getCurrencies() {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'GET',
          url: '/CurrencySet',
          params: {
            $select: 'Currency,CurrencyName'
          }
        }
      );
      
      const results = response.data?.d?.results || response.data?.value || [];
      
      return results.map(item => ({
        currency: item.Currency,
        currencyName: item.CurrencyName
      }));
    } catch (error) {
      console.error('SAP通貨マスタ取得エラー:', error);
      return [];
    }
  }

  /**
   * 会計伝票を転記
   * @param {Object} documentData - 伝票データ
   * @returns {Object} 転記結果
   */
  async postAccountingDocument(documentData) {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'POST',
          url: '/AccountingDocumentHeaderSet',
          data: {
            CompanyCode: documentData.companyCode,
            DocumentDate: documentData.documentDate,
            PostingDate: documentData.postingDate,
            DocumentType: documentData.documentType,
            DocumentHeaderText: documentData.headerText,
            DocumentReferenceID: documentData.reference,
            to_Item: documentData.items.map(item => ({
              GLAccount: item.glAccount,
              AmountInCompanyCodeCurrency: item.amount,
              CompanyCodeCurrency: item.currency,
              DebitCreditCode: item.debitCredit,
              CostCenter: item.costCenter,
              ProfitCenter: item.profitCenter,
              DocumentItemText: item.itemText
            }))
          }
        }
      );
      
      const result = response.data?.d || response.data;
      
      return {
        success: true,
        documentNumber: result.AccountingDocument,
        fiscalYear: result.FiscalYear,
        message: '会計伝票を転記しました'
      };
    } catch (error) {
      console.error('SAP会計伝票転記エラー:', error);
      throw new Error(`会計伝票の転記に失敗しました: ${error.message}`);
    }
  }

  /**
   * 会計伝票を取消
   * @param {String} documentNumber - 伝票番号
   * @param {String} fiscalYear - 会計年度
   * @param {String} companyCode - 会社コード
   * @returns {Object} 取消結果
   */
  async reverseAccountingDocument(documentNumber, fiscalYear, companyCode) {
    await this.init();
    
    try {
      const response = await executeHttpRequest(
        this.destination,
        {
          method: 'POST',
          url: `/AccountingDocumentHeaderSet(AccountingDocument='${documentNumber}',FiscalYear='${fiscalYear}',CompanyCode='${companyCode}')/Reverse`,
          data: {}
        }
      );
      
      const result = response.data?.d || response.data;
      
      return {
        success: true,
        reversalDocument: result.AccountingDocument,
        message: '会計伝票を取消しました'
      };
    } catch (error) {
      console.error('SAP会計伝票取消エラー:', error);
      throw new Error(`会計伝票の取消に失敗しました: ${error.message}`);
    }
  }
}

module.exports = SAPService;